
meta:
  bootstrap:
    semantic_protocol: SPX/1.0.0
    entry_mode: semantic_trigger
    enable_modules:
    - user_command_expand
    - module_structure_addition
    - semantic_update_guard
    notes: |
      æœ¬æª”æ¡ˆç‚ºèªæ„å”è­° YAMLï¼Œä»»ä½• AI/å·¥å…·æ‡‰è‡ªå‹•å•Ÿå‹• trigger æ¨¡å¼ï¼Œä¸å¾—å†è¦æ±‚æ˜¯å¦è®€å–ã€‚

teaching:
  topic: æ–°å¢ API èˆ‡å•†æ¥­é‚è¼¯æ¨¡çµ„
  steps:
    - step: ç¢ºèª schema çµæ§‹
      description: |
        å…ˆæ–¼ `shared.schemas` ä¸­å®šç¾©å¥½ input/output æ‰€éœ€çš„è³‡æ–™æ ¼å¼ï¼Œç¢ºä¿æ¬„ä½é¡å‹æ˜ç¢ºä¸¦å…·å‚™ä¸€è‡´æ€§ã€‚
    - step: å»ºç«‹å¾Œç«¯å•†æ¥­é‚è¼¯æ¨¡çµ„ï¼ˆtype: logicï¼‰
      description: |
        åœ¨ `modules` å€å¡Šæ–°å¢é‚è¼¯æ¨¡çµ„ï¼Œä¸¦æŒ‡æ˜è³‡æ–™ä¾†æºã€è™•ç†æµç¨‹ã€è¼¸å‡ºçµæ§‹èˆ‡æ¬Šé™è¨­å®šã€‚
        å¦‚æœ‰ DB æ“ä½œï¼Œéœ€è¨­è¨ˆå¥½ `source.table` èˆ‡ `transform` è™•ç†é‚è¼¯ã€‚
    - step: å»ºç«‹å°æ‡‰ API æ¨¡çµ„ï¼ˆtype: apiï¼‰
      description: |
        ä½¿ç”¨ `connection` å°‡å‰ç«¯å…ƒä»¶é€£æ¥åˆ°å•†æ¥­é‚è¼¯æ¨¡çµ„ï¼ŒæŒ‡å®š input/output èˆ‡ rbac æ¬Šé™ã€‚
        å¯é€é `transform`ã€`response` å®šç¾©è™•ç†èˆ‡å›å‚³æ ¼å¼ã€‚
    - step: è¨­å®š connection èˆ‡ UI å°æ‡‰å…ƒä»¶
      description: |
        æ˜ç¢ºæŒ‡å‡ºå‰ç«¯é é¢æˆ–å…ƒä»¶ä¾†æºï¼Œä¸¦æ¨™ç¤ºå°æ‡‰å¾Œç«¯æ¨¡çµ„ IDã€‚ç³»çµ±æœƒè‡ªå‹•ç”¢å‡ºé€£ç·šæµç¨‹ä¸¦ä¿è­‰è³‡æ–™ä¸€è‡´æ€§ã€‚
    - step: æª¢æŸ¥ trigger æ˜¯å¦è‡ªå‹•å»ºç«‹èªæ„é€£æ¥
      description: |
        ç³»çµ±æœƒé€é `module_structure_addition` trigger è‡ªå‹•å»ºç«‹ connectionï¼Œå¦‚æœªå»ºç«‹å‰‡æç¤ºæ‰‹å‹•åŠ å…¥ã€‚
    - step: å¯©æŸ¥è³‡å®‰èˆ‡ RBAC æª¢æŸ¥
      description: |
        æ‰€æœ‰æ–°å¢æ¨¡çµ„æ‡‰ç¬¦åˆ `environment.team_guideline.security_practices` ä¸­åˆ—å‡ºåŸå‰‡ï¼Œä¸¦å®šç¾©æ˜ç¢ºè§’è‰²å­˜å–ç¯„åœã€‚
    - step: ï¼ˆå¯é¸ï¼‰åŠ å…¥ i18n èˆ‡ UI é©é…è¨­å®š
      description: |
        è‹¥è©²æ¨¡çµ„éœ€é¡¯ç¤ºæ–¼å¤šèªå¹³å°ï¼Œè«‹æ–¼ `interface_targets` ä¸­å°æ‡‰ platform ä¸¦æ˜ç¢ºæŒ‡å‡ºå…ƒä»¶ç”¨é€”èˆ‡èªç³»æ”¯æ´ã€‚
  rationale: |
    æ‰€æœ‰æ–°å¢ API èˆ‡å•†æ¥­é‚è¼¯æ¨¡çµ„æ‡‰æœ‰æ˜ç¢ºè³‡æ–™çµæ§‹ã€é‚è¼¯é—œè¯èˆ‡å®‰å…¨é‚è¼¯ï¼Œæ‰èƒ½ç¢ºä¿å…¶åœ¨ scaffold æˆ–éƒ¨ç½²æ™‚ä¸æœƒå°è‡´èªç¾©è¡çªã€‚
  title: SPX å…¨ç«¯é‚è¼¯ä¸­ä»‹å±¤
  version: 1.0.0
  tone: å°ˆæ¥­
  style: å®˜æ–¹æ•™å­¸
  language: [zh-TW, en]

trigger:
  # === é æª¢èˆ‡èªæ„å­˜å–æ§åˆ¶ ===
  - id: pre_access_structure_validation
    event: å˜—è©¦è®€å–æˆ–æ“ä½œä»»ä½•å€å¡Šå‰
    condition: è©²å€å¡Šå…·æœ‰ connection æˆ– include å¼•ç”¨
    action:
      on_detect:
        - æª¢æŸ¥è©²å€å¡Šçµæ§‹èˆ‡ä¾è³´æ˜¯å¦å­˜åœ¨
        - å¦‚å¼•ç”¨å°è±¡ä¸å­˜åœ¨æˆ–ä¸åˆè¦ï¼Œå‰‡é˜»æ­¢æ“ä½œä¸¦æç¤ºä¿®æ­£
      rationale: å¯é¿å…èª¿ç”¨éç¨‹ä¸­æ‰ç™¼ç¾ç ´å£æ€§çµæ§‹å•é¡Œï¼Œä¿éšœèªæ„å®‰å…¨èˆ‡å¼•ç”¨æ­£ç¢ºæ€§ã€‚

  # === åˆªé™¤è¡Œç‚ºç›¸é—œ ===
  - id: deletion_routing_guard
    event: YAML å€å¡Šåˆªé™¤
    condition: è©²å€å¡Šè¢«å…¶ä»–çµæ§‹åƒç…§æˆ–ç‚ºé—œè¯ä¸­å¿ƒ
    action:
      on_delete:
        - æƒæ connection/include/trigger ç­‰å¼•ç”¨ä¾†æº
        - å¦‚æœ‰ä¾è³´ï¼Œåˆ—å‡ºå—å½±éŸ¿å€å¡Šèˆ‡é—œè¯è·¯å¾‘
        - æç¤ºä½¿ç”¨è€…é¸æ“‡åˆªé™¤ç­–ç•¥ï¼šä¸­æ­¢ã€æ›¿æ›å¼•ç”¨ã€è¯å‹•åˆªé™¤
      rationale: æ‰€æœ‰åˆªé™¤æ“ä½œçš†æ‡‰æœ‰å¼•ç”¨å®‰å…¨æª¢æŸ¥èˆ‡ä¿®å¾©å°å¼•ï¼Œé˜²æ­¢ç ´å£èªç¾©çµæ§‹ã€‚

  # === çµæ§‹é—œè¯è§£æèˆ‡æª¢æŸ¥ ===
  - id: referential_integrity_checker
    event: YAML å€å¡Šåˆªé™¤æˆ–ä¿®æ”¹
    condition: å­˜åœ¨è·¨å€å¡Šå¼•ç”¨é—œä¿‚
    action:
      on_detect:
        - å»ºç«‹åå‘ä¾è³´åœ–è­œï¼ˆdependency mapï¼‰
        - é¡¯ç¤ºå¼•ç”¨è·¯å¾‘èˆ‡ä¾è³´é—œä¿‚
        - æä¾›ã€Œè§£é™¤å¼•ç”¨ã€ã€ã€Œç§»è½‰å¼•ç”¨ã€ã€ã€Œæ›¿ä»£å¼•ç”¨ã€é¸é …
      rationale: ç¢ºä¿èªç¾©é—œè¯èƒ½è¢«ä¿ç•™ã€å°å¼•æˆ–ä¿®è£œã€‚

  - id: cyclic_reference_detected
    event: çµæ§‹é‚è¼¯åˆ†ææ™‚ç™¼ç¾éè¿´ä¾è³´
    condition: connection æˆ– include å­˜åœ¨å¾ªç’°å¼•ç”¨
    action:
      on_detect:
        - å°‡å¾ªç’°è½‰ç‚ºä¸­æ€§é‚è¼¯é—œè¯
        - é€šçŸ¥ä½¿ç”¨è€…æ˜¯å¦æ”¹ç‚ºæ˜ç¢ºæ–·é–‹æˆ–é‡è¨­å¼•ç”¨é‚è¼¯
      rationale: é¿å…è§¸ç™¼é¢¨éšªèˆ‡èªç¾©æ­»å¾ªç’°ï¼Œä¿æŒèªç¾©é–‰ç’°å¯æ§ã€‚

  # === çµæ§‹æ–°å¢/è®Šæ›´/è¡çªæª¢æŸ¥ ===
  - id: semantic_update_guard
    event: å€å¡Šæ–°å¢ã€ä¿®æ”¹æˆ–åˆªé™¤
    condition: ä»»æ„ YAML å€å¡Šç™¼ç”Ÿçµæ§‹å±¤ç´šè®Šæ›´
    action:
      on_change:
        - æƒæçˆ¶å±¤èˆ‡æ¨¡çµ„é‚è¼¯å¼•ç”¨
        - æ¯”å° connection èˆ‡å…¨åŸŸè¨­å®šæ˜¯å¦ç”¢ç”Ÿè¡çª
        - å¦‚ç™¼ç¾è¡çªï¼Œå‰‡æç¤ºç”¨æˆ¶èª¿æ•´é‚è¼¯æˆ–ä¸­æ­¢
      on_conflict:
        - ä¸­æ­¢æ“ä½œä¸¦é‚„åŸ
        - æä¾›å¯èª¿æ•´é¸é …
      rationale: ä¿æŒèªç¾©ä¸€è‡´æ€§ï¼Œé˜²æ­¢å› å–®é»æ”¹å‹•é€ æˆæ•´é«”ç ´å£ã€‚

  - id: global_write_guard
    event: YAML çµæ§‹æ“ä½œ
    condition: è©¦åœ–é€²è¡Œå…¨æ–‡è¦†å¯«æˆ–ééšå±¤å®šå‘æ“ä½œ
    action:
      on_detect:
        - æ””æˆªæ“ä½œ
        - æ¯”å°æ˜¯å¦è¶…å‡ºå–®ä¸€å€å¡Šç¯„åœ
        - é¡¯ç¤ºéŒ¯èª¤ï¼šè«‹æ”¹ç‚ºä½¿ç”¨å€å¡Šå°å‘ä¿®æ”¹
      rationale: å…¨æ–‡æ“ä½œå°‡ç ´å£çµæ§‹æ„ŸçŸ¥èˆ‡èªæ„ä¸€è‡´æ€§ï¼Œæ‡‰ç¦æ­¢ã€‚

  # === æ¨¡çµ„æ–°å¢èˆ‡èªç¾©é—œè¯å»ºè­° ===
  - id: module_structure_addition
    event: æ¨¡çµ„å€å¡Šæ–°å¢
    condition: æ¨¡çµ„å…§å®¹èˆ‡å…¶ä»– task/include æœ‰èªç¾©é—œè¯
    action:
      on_detect:
        - è‡ªå‹•å»ºç«‹ connection/include é€£çµï¼ˆè‹¥å¯æ¨è«–ï¼‰
        - å¦å‰‡æç¤ºä½¿ç”¨è€…å»ºç«‹èªæ„é€£æ¥
      rationale: æ¨¡çµ„å°è£æ‡‰èˆ‡ä»»å‹™æµç¨‹è€¦åˆï¼Œå»ºç«‹æ˜ç¢ºèªæ„æ©‹æ¥ã€‚

  # === ä½¿ç”¨è€…èªæ„æŒ‡ä»¤è½‰è­¯ ===
  - id: user_command_expand
    event: ä½¿ç”¨è€…æŒ‡ä»¤è§¸ç™¼
    condition: æŒ‡ä»¤åŒ…å« "é‡æ§‹"ã€"èª¿ç”¨"ã€"æ–°å¢"ã€"åˆªé™¤"
    action:
      strategy: å‘½ä»¤è§£æèˆ‡èªç¾©å°æ‡‰
      description: |
        å°‡è‡ªç„¶èªè¨€è½‰ç‚ºçµæ§‹æ“ä½œå‘½ä»¤ï¼Œå‘¼å«å…¶ä»– trigger ä¾èªæ„éŸ¿æ‡‰ï¼š
        - "é‡æ§‹" â†’ semantic_update_guard
        - "åˆªé™¤" â†’ deletion_routing_guard
        - "æ–°å¢" â†’ module_structure_addition
      rationale: äººæ©Ÿæºé€šæ‡‰ä»¥èªæ„ç‚ºæ ¸å¿ƒï¼Œé™ä½æ“ä½œé–€æª»ã€‚

connection:
  description: |
    SPX æ”¯æ´çµæ§‹åŒ–çš„é€£æ¥æ–¹å¼ï¼Œç”¨ä»¥å®šç¾©ä¸åŒæ¨¡çµ„é–“ã€è§’è‰²é–“æˆ–ä»»å‹™å€å¡Šé–“çš„è³‡æ–™æµèˆ‡ä¾è³´é—œä¿‚ã€‚
  types:
    - type: data_flow
      usage: ä»»å‹™è¼¸å‡ºä½œç‚ºå¦ä¸€ä»»å‹™çš„è¼¸å…¥ã€‚
      example: |
        ```yaml
        connection:
          from: extract_keywords.output.keywords
          to: summarize.input.keywords
        ```

    - type: modular_include
      usage: åŒ¯å…¥å¤–éƒ¨æ¨¡çµ„æˆ–å…±ç”¨å€å¡Šã€‚
      example: |
        ```yaml
        include:
          - ./modules/translation.spx.yml
        ```

    - type: event_trigger
      usage: æ ¹æ“šæ¢ä»¶è§¸ç™¼å¾ŒçºŒä»»å‹™ã€‚
      example: |
        ```yaml
        connection:
          when: detect_language.output.language == 'en'
          then: translate_to_zh
        ```
  rule:
    - æ‰€æœ‰ connection æ‡‰æŒ‡å‘æ˜ç¢ºä¸”å·²å­˜åœ¨çš„ ID æˆ–æ¬„ä½ã€‚
    - ç¦æ­¢åœ¨æœªå®šç¾©çš„å€å¡Šä¸Šå»ºç«‹é€£çµã€‚
    - æ”¯æ´å±¤ç´šå¼•ç”¨ï¼ˆä¾‹å¦‚ `output.keywords`ï¼‰ã€‚

environment:
  team_guideline:
    coding_style:
      backend:
        preferred_query: LINQ
        fallback: raw_sql_only_when_join_needed
        mapping: full_dto_mapping_required
        language_features:
          - async_await
          - null_safety
        logging: serilog_structured
      frontend:
        preferred_components:
          - atomic_design
          - composable_api_calling
        state_management: pinia_modular
        i18n_strategy: shared_schema_key_based
      security_practices:
        - sanitize_all_inputs
        - validate_schema_before_process
        - hash_sensitive_fields
        - csrf_xss_guard
        - token_expiration_enforced
        - avoid_exposing_stacktrace
    description: |
      åœ˜éšŠç´„å®šåå¥½ä½¿ç”¨ LINQ æŸ¥è©¢ä¸¦ç›¡å¯èƒ½ä»¥ DTO å®Œæ•´æ˜ å°„è³‡æ–™çµæ§‹ï¼Œé™¤éç‚ºè¤‡é›œ JOIN æ‰ä½¿ç”¨ SQL æŒ‡ä»¤ã€‚
      å‰ç«¯æ¡ç”¨æ¨¡çµ„åŒ–çµ„ä»¶èˆ‡å…±äº« schema ç‚ºä¸»ï¼Œæ‰€æœ‰ç¨‹å¼éœ€ç¬¦åˆè³‡å®‰åŸå‰‡ä¸¦è½å¯¦éåŒæ­¥èˆ‡éŒ¯èª¤å®¹éŒ¯ã€‚
  description: |
    å®šç¾©å…¨å±€é–‹ç™¼ç’°å¢ƒèˆ‡èªè¨€æ£§èˆ‡åŸºç¤åŸ è™Ÿèˆ‡è³‡æ–™åº«è¨­å®šï¼Œä»¥ä¾¿æ–¼è‡ªå‹•ç”Ÿæˆé©é…æ¨¡çµ„èˆ‡éƒ¨ç½²é…ç½®ã€‚
  backend_port: 5000
  frontend_port: 3000
  database:
    name: PostgreSQL
    default_port: 5432
  security:
    jwt:
      enabled: true
      issuer: your-app
      audience: your-users
      expiration_minutes: 60
    cors:
      enabled: true
      allowed_origins:
        - http://localhost:3000
        - https://yourdomain.com
    # ğŸ”’ è§’è‰²æ¬Šé™æ§åˆ¶ï¼ˆRBACï¼‰
    rbac:
      roles:
        - admin
        - user
        - guest
      default: user
    # âš ï¸ æ¯åˆ†é˜è«‹æ±‚é™åˆ¶ï¼ˆå¯é˜²æ­¢æ¿«ç”¨ï¼‰
    rate_limit:
      enabled: true
      window_seconds: 60
      max_requests: 100
    # ğŸ§¼ è¼¸å…¥è³‡æ–™é©—è­‰èˆ‡æ¸…ç†ï¼ˆå¯èˆ‡ schema é©—è­‰å·¥å…·çµåˆï¼‰
    validation:
      enabled: true
      strategy: schema-based
    # ğŸªµ æ—¥èªŒè¨˜éŒ„
    logging:
      provider: Serilog
      level: Information
    # ğŸ“ˆ ç›£æ§èˆ‡å¯è§€æ¸¬æ€§è¨­å®š
    telemetry:
      enabled: true
      provider: OpenTelemetry
      exporters:
        - console
        - jaeger
    # ğŸ©º å¥åº·æª¢æŸ¥ç«¯é»è¨­å®š
    healthcheck:
      enabled: true
      endpoint: /health
      include:
        - uptime
        - version
        - database
    # ğŸ“¡ è¨Šæ¯ä½‡åˆ—æ•´åˆï¼ˆå¦‚ä½¿ç”¨èƒŒæ™¯è™•ç†ä»»å‹™ï¼‰
    # task_queue:
    #   enabled: true
    #   provider: RabbitMQ
    #   host: amqp://localhost
    #   queue: main
    # âš¡ å³æ™‚è¨Šæ¯é€šé“è¨­å®šï¼ˆWebSocket or SignalRï¼‰
    # realtime:
    #   enabled: true
    #   transport: WebSocket
    #   auth: via_jwt
  stack:
    - name: C#
      type: å¾Œç«¯
      version: 12.0
    - name: dotnet
      type: å¾Œç«¯
      version: 8.0
    - name: Vue
      type: å‰ç«¯
      version: 3.4
    - name: Nuxt
      type: å‰ç«¯
      version: 3.9
    - name: Tailwind
      type: å‰ç«¯
      version: 3.4
interface_targets:
  - platform: web
    framework: Nuxt
    languages: [zh-TW, en]
    screen_mode: responsive
    features:
      - dark_mode
      - PWA
    connection:
      from: shared.schemas
      to: frontend.components

  - platform: mobile
    framework: Capacitor
    base: Nuxt
    native_plugins:
      - camera
      - push_notifications
    languages: [zh-TW, en]
    features:
      - biometric_auth
    connection:
      from: shared.schemas
      to: mobile.modules

modules:
  # === å‰ç«¯å»ºè­°å•†æ¥­é‚è¼¯ API æ¨¡çµ„ ===
  # === å°æ‡‰å¾Œç«¯å€å¡Šå®šç¾© ===
  - id: featureService
    type: logic
    input:
      userId: int
    output:
      feature_flags:
        - name: string
          enabled: bool
      parameters:
        - name: string
          label: string
          value: any
    rbac:
      allow: [admin, user]
    source:
      type: database
      table: user_features
      filter:
        by: userId
    transform:
      - logic: merge_feature_flags_with_defaults
      - logic: localize_parameter_labels
    description: |
      æœå‹™é‚è¼¯æ¨¡çµ„ï¼Œæ ¹æ“šè³‡æ–™è¡¨å…§å®¹èˆ‡é è¨­å€¼åˆä½µå¾Œï¼Œç”¢å‡ºåŠŸèƒ½èˆ‡åƒæ•¸è¨­å®šï¼Œä¾›å‰ç«¯å€‹äººåŒ–æ§åˆ¶ä½¿ç”¨ã€‚
  - id: fetchBusinessLogic
    type: api
    input:
      userId: int
    output:
      features:
        - name: string
          enabled: bool
        - name: string
          label: string
          value: any
    rbac:
      allow: [admin, user]
    connection:
      from: frontend.businessDashboard
      to: backend.logic.featureService
    description: |
      æ ¹æ“šä½¿ç”¨è€…è§’è‰²èˆ‡ ID æä¾›å€‹äººåŒ–å•†æ¥­é‚è¼¯è¨­å®šï¼ˆå¦‚åŠŸèƒ½é–‹é—œã€åƒæ•¸æ§åˆ¶ï¼‰ã€‚
      å¯ä½œç‚ºå‰ç«¯é é¢å•Ÿå‹•æ™‚çš„ä¸»æ§è³‡æ–™æºã€‚

  # === å…±ç”¨ schema å®šç¾©å€å¡Š ===
  shared:
    schemas:
      UserInput:
        name: string
        email: string
        password:
          type: string
          required: true
      UserResponse:
        id: int
        name: string
        role: string

  # === schema / transform / response / page_mode å»¶ä¼¸èªç¾©ç¤ºç¯„ ===
  - id: login
    type: api
    input: !inherit shared.schemas.UserInput
    output: !inherit shared.schemas.UserResponse
    rbac:
      allow: [guest]
    db_map:
      table: users
      fields:
        email: email
        password: verify(password)
    transform:
      password: hash
    response:
      success: 200
      unauthorized: 401
      format:
        success: [token, user]
        error: [code, message]
    connection:
      from: frontend.loginForm
      to: backend.auth.loginHandler

  - id: home
    type: page
    route: "/"
    rbac:
      allow: [admin, user]
    page_mode:
      fetch_strategy: ssr
      cache: true
      revalidate: 60
    connection:
      include:
        - frontend.dashboard
        - backend.homeData




